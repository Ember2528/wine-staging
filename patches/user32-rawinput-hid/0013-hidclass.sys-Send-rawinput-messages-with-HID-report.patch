From 478c213d97d8894d734d8f711f6d4c75d9ea84fa Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?R=C3=A9mi=20Bernon?= <rbernon@codeweavers.com>
Date: Fri, 5 Mar 2021 10:41:20 +0100
Subject: [PATCH] hidclass.sys: Send rawinput messages with HID report.

Wine-Bug: https://bugs.winehq.org/show_bug.cgi?id=50506
---
 dlls/hidclass.sys/device.c | 35 +++++++++++++++++++++++++++++++++++
 1 file changed, 35 insertions(+)

diff --git a/dlls/hidclass.sys/device.c b/dlls/hidclass.sys/device.c
index ec34b6b8068..887d7212c89 100644
--- a/dlls/hidclass.sys/device.c
+++ b/dlls/hidclass.sys/device.c
@@ -171,6 +171,39 @@ static NTSTATUS copy_packet_into_buffer(HID_XFER_PACKET *packet, BYTE* buffer, U
         return STATUS_BUFFER_OVERFLOW;
 }
 
+static void HID_Device_sendRawInput(DEVICE_OBJECT *device, HID_XFER_PACKET *packet)
+{
+    BASE_DEVICE_EXTENSION *ext = device->DeviceExtension;
+    RAWINPUT *rawinput;
+    UCHAR *report, id;
+    ULONG data_size;
+    INPUT input;
+
+    data_size = offsetof(RAWINPUT, data.hid.bRawData) + packet->reportBufferLen;
+    if (!(id = ext->u.pdo.preparsed_data->reports[0].reportID)) data_size += 1;
+
+    rawinput = HeapAlloc(GetProcessHeap(), 0, data_size);
+
+    rawinput->header.dwType = RIM_TYPEHID;
+    rawinput->header.dwSize = data_size;
+    rawinput->header.hDevice = ULongToHandle(ext->u.pdo.rawinput_handle);
+    rawinput->header.wParam = RIM_INPUT;
+    rawinput->data.hid.dwCount = 1;
+    rawinput->data.hid.dwSizeHid = data_size - offsetof(RAWINPUT, data.hid.bRawData);
+
+    report = rawinput->data.hid.bRawData;
+    if (!id) *report++ = 0;
+    memcpy(report, packet->reportBuffer, packet->reportBufferLen);
+
+    input.type = INPUT_HARDWARE;
+    input.u.hi.uMsg = WM_INPUT;
+    input.u.hi.wParamH = (WORD)(rawinput->header.dwSize >> 16);
+    input.u.hi.wParamL = (WORD)(rawinput->header.dwSize >> 0);
+    __wine_send_input(0, &input, rawinput);
+
+    HeapFree(GetProcessHeap(), 0, rawinput);
+}
+
 static void HID_Device_processQueue(DEVICE_OBJECT *device)
 {
     IRP *irp;
@@ -242,6 +275,7 @@ static DWORD CALLBACK hid_device_thread(void *args)
             if (irp_status.u.Status == STATUS_SUCCESS)
             {
                 RingBuffer_Write(ext->u.pdo.ring_buffer, packet);
+                HID_Device_sendRawInput(device, packet);
                 HID_Device_processQueue(device);
             }
 
@@ -282,6 +316,7 @@ static DWORD CALLBACK hid_device_thread(void *args)
                 else
                     packet->reportId = 0;
                 RingBuffer_Write(ext->u.pdo.ring_buffer, packet);
+                HID_Device_sendRawInput(device, packet);
                 HID_Device_processQueue(device);
             }
 
-- 
2.30.2

