From 4275e2569a44939e04098fca9cf8beab4cb3941e Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Sun, 13 Sep 2020 13:39:07 +1000
Subject: [PATCH] winegstreamer: Support older versions

---
 configure.ac                      | 4 +++-
 dlls/winegstreamer/media_source.c | 2 ++
 3 files changed, 14 insertions(+), 1 deletion(-)

diff --git a/configure.ac b/configure.ac
index 5d882b94d99..8abd50e6690 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1665,7 +1665,9 @@ then
               AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[#include <gst/gst.h>]],
                                                  [[static int a[sizeof(gint64) > 4 ? 1 : -1]; if (a[0]) return 0;]])],
                 [AC_MSG_RESULT([yes])
-                 AC_CHECK_LIB(gstreamer-1.0,gst_pad_new,[:],,[$GSTREAMER_LIBS])],
+                 AC_CHECK_LIB(gstreamer-1.0,gst_pad_new,[:],,[$GSTREAMER_LIBS])
+                 WINE_CHECK_LIB_FUNCS([gst_structure_get_list], [$GSTREAMER_LIBS])
+                 ],
                 [AC_MSG_RESULT([no])
                  ac_glib2_broken=yes
                  WINE_NOTICE([glib-2.0 pkgconfig configuration is for the wrong architecture, winegstreamer won't be built.])])])])
diff --git a/dlls/winegstreamer/media_source.c b/dlls/winegstreamer/media_source.c
index 07c16ac8a07..3ef258937dc 100644
--- a/dlls/winegstreamer/media_source.c
+++ b/dlls/winegstreamer/media_source.c
@@ -1087,6 +1087,7 @@ static HRESULT media_stream_init_desc(struct media_stream *stream)
 
     if (!strcmp(gst_structure_get_name(gst_caps_get_structure(stream->their_caps, 0)), "video/x-raw"))
     {
+#ifdef HAVE_GST_STRUCTURE_GET_LIST
         GstElementFactory *videoconvert_factory = gst_element_factory_find("videoconvert");
         /* output every format supported by videoconvert */
         const GList *template_list = gst_element_factory_get_static_pad_templates(videoconvert_factory);
@@ -1118,6 +1119,7 @@ static HRESULT media_stream_init_desc(struct media_stream *stream)
             gst_caps_unref(src_caps);
             break;
         }
+#endif
     }
     else if (!strcmp(gst_structure_get_name(gst_caps_get_structure(stream->their_caps, 0)), "audio/x-raw"))
     {
-- 
2.28.0

