From e5652dcb913e0bf956c5ed4b0d1e1755c58714c5 Mon Sep 17 00:00:00 2001
From: Alex Henrie <alexhenrie24@gmail.com>
Date: Tue, 29 Dec 2015 00:48:02 -0700
Subject: [PATCH] mountmgr.sys: Do a device check before returning a default
 serial port name.

Fixes https://bugs.winehq.org/show_bug.cgi?id=39793
---
 dlls/mountmgr.sys/device.c | 32 +++++++++++++++++++++++++++++---
 1 file changed, 29 insertions(+), 3 deletions(-)

diff --git a/dlls/mountmgr.sys/device.c b/dlls/mountmgr.sys/device.c
index 332f390550d..666bdb12e6b 100644
--- a/dlls/mountmgr.sys/device.c
+++ b/dlls/mountmgr.sys/device.c
@@ -23,6 +23,11 @@
 #include <stdarg.h>
 #include <stdio.h>
 #include <stdlib.h>
+#include <fcntl.h>
+#include <unistd.h>
+#ifdef HAVE_TERMIOS_H
+# include <termios.h>
+#endif
 #ifdef HAVE_SYS_STATFS_H
 # include <sys/statfs.h>
 #endif
@@ -1918,9 +1923,6 @@ static BOOL create_port_device( DRIVER_OBJECT *driver, int n, const char *unix_p
     NTSTATUS status;
     struct set_dosdev_symlink_params params = { dosdevices_path, unix_path };
 
-    /* create DOS device */
-    if (MOUNTMGR_CALL( set_dosdev_symlink, &params )) return FALSE;
-
     if (driver == serial_driver)
     {
         dos_name_format = L"COM%u";
@@ -1940,6 +1942,30 @@ static BOOL create_port_device( DRIVER_OBJECT *driver, int n, const char *unix_p
 
     swprintf( dos_name, ARRAY_SIZE(dos_name), dos_name_format, n );
 
+#ifdef linux
+    /* Serial port device files almost always exist on Linux even if the corresponding serial
+     * ports don't exist. Do a basic functionality check before advertising a serial port. */
+    if (driver == serial_driver)
+    {
+        struct termios tios;
+        int fd;
+
+        if ((fd = open( unix_path, O_RDONLY )) == -1)
+            return FALSE;
+
+        if (tcgetattr( fd, &tios ) == -1)
+        {
+            close( fd );
+            return FALSE;
+        }
+
+        close( fd );
+    }
+#endif
+
+    /* create DOS device */
+    if (MOUNTMGR_CALL( set_dosdev_symlink, &params )) return FALSE;
+    
     /* create NT device */
     swprintf( nt_buffer, ARRAY_SIZE(nt_buffer), nt_name_format, n - 1 );
     RtlInitUnicodeString( &nt_name, nt_buffer );
-- 
2.33.0

