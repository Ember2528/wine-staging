From feb19e6a9ae86a2a17a981ab7f69481e57c2a465 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?R=C3=A9mi=20Bernon?= <rbernon@codeweavers.com>
Date: Tue, 13 Oct 2020 11:35:49 +0200
Subject: [PATCH] widl: Support WinRT mta threading attribute parsing.

---
 tools/widl/header.c    | 28 ++++++++++++++++++++++++++++
 tools/widl/parser.l    |  1 +
 tools/widl/parser.y    |  2 ++
 tools/widl/widltypes.h |  3 ++-
 4 files changed, 33 insertions(+), 1 deletion(-)

diff --git a/tools/widl/header.c b/tools/widl/header.c
index d5e35aac92f..aaae2fcf3c8 100644
--- a/tools/widl/header.c
+++ b/tools/widl/header.c
@@ -1480,6 +1480,34 @@ static char *format_apicontract_macro(const type_t *type)
     return name;
 }
 
+static void write_winrt_type_comments(FILE *header, const type_t *type)
+{
+    expr_t *contract = get_attrp(type->attrs, ATTR_CONTRACT);
+    fprintf(header, " *\n");
+    if (contract)
+    {
+        const type_t *type = contract->u.tref.type;
+        char *name = format_namespace(type->namespace, "", ".", type->name, NULL);
+        int ver = contract->ref->u.lval;
+        fprintf(header, " * Introduced to %s in version %d.%d\n *\n", name, (ver >> 16) & 0xffff, ver & 0xffff);
+        free(name);
+    }
+    switch (get_attrv(type->attrs, ATTR_THREADING))
+    {
+        case THREADING_SINGLE: fprintf(header, " * Class Threading Model:  Single Threaded Apartment\n *\n"); break;
+        case THREADING_BOTH: fprintf(header, " * Class Threading Model:  Both Single and Multi Threaded Apartment\n *\n"); break;
+        case THREADING_MTA: fprintf(header, " * Class Threading Model:  Multi Threaded Apartment\n *\n"); break;
+        default: break;
+    }
+    switch (get_attrv(type->attrs, ATTR_MARSHALING_BEHAVIOR))
+    {
+        case MARSHALING_AGILE: fprintf(header, " * Class Marshaling Behavior:  Agile - Class is agile\n *\n"); break;
+        case MARSHALING_STANDARD: fprintf(header, " * Class Marshaling Behavior:  Standard - Class marshals using the standard marshaler\n *\n"); break;
+        case MARSHALING_NONE: fprintf(header, " * Class Marshaling Behavior:  None - Class cannot be marshaled\n *\n"); break;
+        default: break;
+    }
+}
+
 static void write_apicontract_guard_start(FILE *header, const expr_t *expr)
 {
     const type_t *type;
diff --git a/tools/widl/parser.l b/tools/widl/parser.l
index 01c6f800a08..067966a85d4 100644
--- a/tools/widl/parser.l
+++ b/tools/widl/parser.l
@@ -385,6 +385,7 @@ static const struct keyword attr_keywords[] =
 	{"marshaling_behavior",         tMARSHALINGBEHAVIOR,        1},
 	{"maybe",                       tMAYBE,                     0},
 	{"message",                     tMESSAGE,                   0},
+	{"mta" ,                        tMTA,                       1},
 	{"neutral",                     tNEUTRAL,                   0},
 	{"nocode",                      tNOCODE,                    0},
 	{"nonbrowsable",                tNONBROWSABLE,              0},
diff --git a/tools/widl/parser.y b/tools/widl/parser.y
index 48f180cdb49..fd994ae70bb 100644
--- a/tools/widl/parser.y
+++ b/tools/widl/parser.y
@@ -222,6 +222,7 @@ static typelib_t *current_typelib;
 %token tMAYBE tMESSAGE
 %token tMETHODS
 %token tMODULE
+%token tMTA
 %token tNAMESPACE
 %token tNOCODE tNONBROWSABLE
 %token tNONCREATABLE
@@ -1154,6 +1155,7 @@ threading_type:
 	| tSINGLE				{ $$ = THREADING_SINGLE; }
 	| tFREE					{ $$ = THREADING_FREE; }
 	| tBOTH					{ $$ = THREADING_BOTH; }
+	| tMTA					{ $$ = THREADING_MTA; }
 	;
 
 pointer_type:
diff --git a/tools/widl/widltypes.h b/tools/widl/widltypes.h
index 6c130d4701e..8a3bd00e340 100644
--- a/tools/widl/widltypes.h
+++ b/tools/widl/widltypes.h
@@ -269,7 +269,8 @@ enum threading_type
     THREADING_NEUTRAL,
     THREADING_SINGLE,
     THREADING_FREE,
-    THREADING_BOTH
+    THREADING_BOTH,
+    THREADING_MTA,
 };
 
 enum marshaling_type
-- 
2.29.2

