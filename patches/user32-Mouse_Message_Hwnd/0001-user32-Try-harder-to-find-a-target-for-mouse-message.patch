From 613c51cb67f5ecd654cfd32478b94d9a739856e2 Mon Sep 17 00:00:00 2001
From: Dmitry Timoshkov <dmitry@codeweavers.com>
Date: Tue, 25 Nov 2014 20:31:58 +0100
Subject: [PATCH] user32: Try harder to find a target for mouse messages

---
 dlls/user32/message.c     | 1 -
 dlls/user32/tests/input.c | 4 ++--
 dlls/win32u/message.c     | 4 ++--
 3 files changed, 4 insertions(+), 5 deletions(-)

diff --git a/dlls/user32/message.c b/dlls/user32/message.c
index 0b4d4ecc603..a53889afc37 100644
--- a/dlls/user32/message.c
+++ b/dlls/user32/message.c
@@ -592,7 +592,6 @@ BOOL process_rawinput_message( MSG *msg, UINT hw_id, const struct hardware_msg_d
     return TRUE;
 }
 
-
 /***********************************************************************
  *		SendMessageTimeoutW  (USER32.@)
  */
diff --git a/dlls/user32/tests/input.c b/dlls/user32/tests/input.c
index d7520459c6d..0969c41edcb 100644
--- a/dlls/user32/tests/input.c
+++ b/dlls/user32/tests/input.c
@@ -3466,8 +3466,8 @@ static void test_Input_mouse(void)
         }
     }
     ok(hittest_no && hittest_no<50, "expected WM_NCHITTEST message\n");
-    todo_wine ok(got_button_down, "expected WM_LBUTTONDOWN message\n");
-    todo_wine ok(got_button_up, "expected WM_LBUTTONUP message\n");
+    ok(got_button_down, "expected WM_LBUTTONDOWN message\n");
+    ok(got_button_up, "expected WM_LBUTTONUP message\n");
     DestroyWindow(static_win);
 
     /* click on HTTRANSPARENT top-level window that belongs to other thread */
diff --git a/dlls/win32u/message.c b/dlls/win32u/message.c
index 8d32eaf2f2d..ff6884ca364 100644
--- a/dlls/win32u/message.c
+++ b/dlls/win32u/message.c
@@ -1400,8 +1400,8 @@ static BOOL process_mouse_message( MSG *msg, UINT hw_id, ULONG_PTR extra_info, H
     else
     {
         HWND orig = msg->hwnd;
-
-        msg->hwnd = window_from_point( msg->hwnd, msg->pt, &hittest );
+        
+        msg->hwnd = window_from_point( 0, msg->pt, &hittest );
         if (!msg->hwnd) /* As a heuristic, try the next window if it's the owner of orig */
         {
             HWND next = get_window_relative( orig, GW_HWNDNEXT );
-- 
2.35.1

