From 92381fe379f4e971168e1e3d9c67394eb8d0f697 Mon Sep 17 00:00:00 2001
From: "Erich E. Hoover" <erich.e.hoover@wine-staging.com>
Date: Mon, 23 Nov 2020 13:08:02 -0700
Subject: [PATCH] ntdll: Succeed with no data for NtReadFile on reparse points.

Signed-off-by: Erich E. Hoover <erich.e.hoover@gmail.com>
---
 dlls/ntdll/tests/file.c | 2 +-
 dlls/ntdll/unix/file.c  | 5 +++++
 server/file.c           | 1 +
 server/protocol.def     | 1 +
 4 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/dlls/ntdll/tests/file.c b/dlls/ntdll/tests/file.c
index 92cff9d9b2e..1e867146cd9 100644
--- a/dlls/ntdll/tests/file.c
+++ b/dlls/ntdll/tests/file.c
@@ -5591,7 +5591,7 @@ static void test_reparse_points(void)
     ok(handle != INVALID_HANDLE_VALUE, "Failed to open symlink file.\n");
     todo_wine ok(GetFileSize(handle, NULL) == 0, "symlink size is not zero\n");
     bret = ReadFile(handle, &buf, sizeof(buf), &dwLen, NULL);
-    todo_wine ok(bret, "Failed to read data from the symlink.\n");
+    ok(bret, "Failed to read data from the symlink.\n");
     ok(dwLen == 0, "Length of symlink data is not zero.\n");
     CloseHandle(handle);
 
diff --git a/dlls/ntdll/unix/file.c b/dlls/ntdll/unix/file.c
index 0d6f08072a7..d7e0be3f65c 100644
--- a/dlls/ntdll/unix/file.c
+++ b/dlls/ntdll/unix/file.c
@@ -5415,6 +5415,11 @@ NTSTATUS WINAPI NtReadFile( HANDLE handle, HANDLE event, PIO_APC_ROUTINE apc, vo
         if (needs_close) close( unix_handle );
         return status;
     }
+    else if (type == FD_TYPE_SYMLINK)
+    {
+        status = STATUS_SUCCESS;
+        goto done;
+    }
 
     if (type == FD_TYPE_SERIAL && async_read && length)
     {
diff --git a/server/file.c b/server/file.c
index eb2dc5696ed..b9d0eb2d5f4 100644
--- a/server/file.c
+++ b/server/file.c
@@ -294,6 +294,7 @@ static enum server_fd_type file_get_fd_type( struct fd *fd )
 {
     struct file *file = get_fd_user( fd );
 
+    if (S_ISLNK(file->mode)) return FD_TYPE_SYMLINK;
     if (S_ISREG(file->mode) || S_ISBLK(file->mode)) return FD_TYPE_FILE;
     if (S_ISDIR(file->mode)) return FD_TYPE_DIR;
     return FD_TYPE_CHAR;
diff --git a/server/protocol.def b/server/protocol.def
index 93c17e091cb..238e23b0a85 100644
--- a/server/protocol.def
+++ b/server/protocol.def
@@ -1382,6 +1382,7 @@ enum server_fd_type
 {
     FD_TYPE_INVALID,  /* invalid file (no associated fd) */
     FD_TYPE_FILE,     /* regular file */
+    FD_TYPE_SYMLINK,  /* symbolic link */
     FD_TYPE_DIR,      /* directory */
     FD_TYPE_SOCKET,   /* socket */
     FD_TYPE_SERIAL,   /* serial port */
-- 
2.35.1

